import asyncio
import os
import json
from datetime import datetime, timedelta
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    ConversationHandler,
    filters
)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
TOKEN = "8359184554:AAGbtfDrjt32k0BJ77OMHrentRhEnkXpjmE"
DATA_FILE = "schedules.json"
REMINDER_TIME_DELTA = timedelta(minutes=30)  # –ù–∞–ø–æ–º–∏–Ω–∞—Ç—å –∑–∞ 30 –º–∏–Ω—É—Ç –¥–æ —Å–æ–±—ã—Ç–∏—è

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler
DATE, TIME, TEXT = range(3)

# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
class ScheduleManager:
    def __init__(self):
        self.schedules = self.load_schedules()
    
    def load_schedules(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞."""
        if os.path.exists(DATA_FILE):
            try:
                with open(DATA_FILE, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π: {e}")
                return {}
        return {}
    
    def save_schedules(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ —Ñ–∞–π–ª."""
        with open(DATA_FILE, 'w', encoding='utf-8') as f:
            json.dump(self.schedules, f, ensure_ascii=False, indent=2)
    
    def add_schedule(self, user_id: int, date_time_str: str, schedule_text: str) -> int:
        """–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è."""
        if str(user_id) not in self.schedules:
            self.schedules[str(user_id)] = {}
            
        if date_time_str not in self.schedules[str(user_id)]:
            self.schedules[str(user_id)][date_time_str] = {}
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π id —Å–æ–±—ã—Ç–∏—è
        next_id = 1
        existing_ids = set(map(int, self.schedules[str(user_id)][date_time_str].keys()))
        while next_id in existing_ids:
            next_id += 1
        
        self.schedules[str(user_id)][date_time_str][str(next_id)] = {
            "text": schedule_text,
            "date_created": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        
        self.save_schedules()
        return next_id
    
    def get_schedules_by_date(self, user_id: int, date_str: str) -> dict:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É."""
        user_schedules = self.schedules.get(str(user_id), {})
        
        # –ò—â–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —ç—Ç—É –¥–∞—Ç—É (–ª—é–±–æ–µ –≤—Ä–µ–º—è)
        result = {}
        for datetime_str, events in user_schedules.items():
            if datetime_str.startswith(date_str):
                result.update(events)
        
        return result
    
    def get_schedules_today(self, user_id: int) -> dict:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è."""
        today = datetime.now().strftime('%Y-%m-%d')
        return self.get_schedules_by_date(user_id, today)
    
    def get_schedules_tomorrow(self, user_id: int) -> dict:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞."""
        tomorrow = (datetime.now() + timedelta(days=1)).strftime('%Y-%m-%d')
        return self.get_schedules_by_date(user_id, tomorrow)
    
    def remove_schedule(self, user_id: int, date_time_str: str, schedule_id: str) -> bool:
        """–£–¥–∞–ª—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏."""
        schedules = self.schedules.get(str(user_id), {}).get(date_time_str, {})
        if schedule_id in schedules:
            del schedules[schedule_id]
            self.save_schedules()
            return True
        return False
    
    def clear_schedules_on_date(self, user_id: int, date_str: str) -> bool:
        """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é –¥–∞—Ç—É."""
        if str(user_id) in self.schedules:
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å —ç—Ç–æ–π –¥–∞—Ç—ã
            keys_to_remove = [k for k in self.schedules[str(user_id)].keys() if k.startswith(date_str)]
            for key in keys_to_remove:
                del self.schedules[str(user_id)][key]
            self.save_schedules()
            return True
        return False

# –ú–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
schedule_manager = ScheduleManager()

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
def format_schedules(schedules: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥."""
    if not schedules:
        return "–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π"
    
    result = []
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    sorted_items = sorted(
        [(datetime_str, data) for datetime_str, events in schedules.items() for data in events.values()],
        key=lambda x: x[0]  # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ-–≤—Ä–µ–º–µ–Ω–∏
    )
    
    for datetime_str, data in sorted_items:
        time_only = datetime_str.split()[1][:5] if ' ' in datetime_str else "??:??"
        text = data["text"][:30] + ("..." if len(data["text"]) > 30 else "")
        result.append(f"üïí {time_only} - {text}")
    
    return '\n'.join(result)

def format_schedules_for_date(date_schedules: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–∞—Ç—ã."""
    if not date_schedules:
        return "–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π"
    
    result = []
    for event_id, data in date_schedules.items():
        text = data["text"][:40] + ("..." if len(data["text"]) > 40 else "")
        result.append(f"ID {event_id}: {text}")
    
    return '\n'.join(result)

def build_main_menu():
    """–°–æ–∑–¥–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–º–∞–Ω–¥–∞–º."""
    return ReplyKeyboardMarkup([
        ['üìÖ –°–µ–≥–æ–¥–Ω—è', 'üìÖ –ó–∞–≤—Ç—Ä–∞'],
        ['‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ', 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ'],
        ['üìã –í—Å–µ —Å–æ–±—ã—Ç–∏—è', 'üóìÔ∏è –ö–∞–ª–µ–Ω–¥–∞—Ä—å'],
        ['‚ùì –ü–æ–º–æ—â—å']
    ], resize_keyboard=True)

def create_date_keyboard():
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã."""
    today = datetime.now()
    
    buttons = []
    row = []
    
    # 7 –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥
    for i in range(7):
        date = today + timedelta(days=i)
        date_str = date.strftime('%d.%m')
        weekday = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"][date.weekday()]
        
        if i == 0:
            label = f"–°–µ–≥–æ–¥–Ω—è ({date_str})"
        elif i == 1:
            label = f"–ó–∞–≤—Ç—Ä–∞ ({date_str})"
        else:
            label = f"{weekday} {date_str}"
        
        row.append(InlineKeyboardButton(label, callback_data=f"date_{date.strftime('%Y-%m-%d')}"))
        
        if len(row) == 2:
            buttons.append(row)
            row = []
    
    if row:
        buttons.append(row)
    
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π –¥–∞—Ç—ã
    buttons.append([InlineKeyboardButton("üìÖ –î—Ä—É–≥–∞—è –¥–∞—Ç–∞", callback_data="other_date")])
    buttons.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel")])
    
    return InlineKeyboardMarkup(buttons)

def create_time_keyboard():
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏."""
    buttons = []
    row = []
    
    # –ß–∞—Å—ã —Å 8 —É—Ç—Ä–∞ –¥–æ 10 –≤–µ—á–µ—Ä–∞
    for hour in range(8, 22):
        for minute in [0, 30]:
            time_str = f"{hour:02d}:{minute:02d}"
            row.append(InlineKeyboardButton(time_str, callback_data=f"time_{time_str}"))
            
            if len(row) == 3:
                buttons.append(row)
                row = []
    
    if row:
        buttons.append(row)
    
    buttons.append([InlineKeyboardButton("‚è∞ –î—Ä—É–≥–æ–µ –≤—Ä–µ–º—è", callback_data="other_time")])
    buttons.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel")])
    
    return InlineKeyboardMarkup(buttons)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
async def send_reminder(context: ContextTypes.DEFAULT_TYPE):
    job = context.job
    user_id = job.user_id
    event_text = job.event_text
    reminder_time = job.reminder_time
    
    await context.bot.send_message(
        chat_id=user_id, 
        text=f"üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {event_text} –≤ {reminder_time}",
        parse_mode='HTML'
    )

# –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –ø–æ–º–æ—â—å –ø–æ —Ä–∞–±–æ—Ç–µ —Å –±–æ—Ç–æ–º."""
    help_text = (
        "üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á!</b>\n\n"
        "–Ø –ø–æ–º–æ–≥—É –≤–∞–º –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –≤–∞—à–µ –≤—Ä–µ–º—è –∏ –Ω–µ –∑–∞–±—ã—Ç—å –æ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö.\n\n"
        "üìã <b>–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>\n"
        "‚Ä¢ üìÖ –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞\n"
        "‚Ä¢ ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π\n"
        "‚Ä¢ üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π\n"
        "‚Ä¢ üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π\n"
        "‚Ä¢ üóìÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è\n\n"
        "üîî –Ø –±—É–¥—É –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –≤–∞–º –æ —Å–æ–±—ã—Ç–∏—è—Ö –∑–∞ 30 –º–∏–Ω—É—Ç –¥–æ –∏—Ö –Ω–∞—á–∞–ª–∞!"
    )
    await update.message.reply_html(help_text, reply_markup=build_main_menu())

async def show_today(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å."""
    user_id = update.effective_user.id
    schedules = schedule_manager.get_schedules_today(user_id)
    
    today_str = datetime.now().strftime('%d.%m.%Y')
    
    if not schedules:
        response = f"üìÖ <b>–ù–∞ —Å–µ–≥–æ–¥–Ω—è ({today_str})</b>\n\n–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π üòä"
    else:
        formatted_schedules = format_schedules(schedules)
        response = f"üìÖ <b>–ù–∞ —Å–µ–≥–æ–¥–Ω—è ({today_str})</b>\n\n{formatted_schedules}"
    
    await update.message.reply_html(response, reply_markup=build_main_menu())

async def show_tomorrow(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞."""
    user_id = update.effective_user.id
    schedules = schedule_manager.get_schedules_tomorrow(user_id)
    
    tomorrow = datetime.now() + timedelta(days=1)
    tomorrow_str = tomorrow.strftime('%d.%m.%Y')
    
    if not schedules:
        response = f"üìÖ <b>–ù–∞ –∑–∞–≤—Ç—Ä–∞ ({tomorrow_str})</b>\n\n–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π üòä"
    else:
        formatted_schedules = format_schedules(schedules)
        response = f"üìÖ <b>–ù–∞ –∑–∞–≤—Ç—Ä–∞ ({tomorrow_str})</b>\n\n{formatted_schedules}"
    
    await update.message.reply_html(response, reply_markup=build_main_menu())

async def show_all_events(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è."""
    user_id = update.effective_user.id
    user_schedules = schedule_manager.schedules.get(str(user_id), {})
    
    if not user_schedules:
        await update.message.reply_html("üìã –£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π.", reply_markup=build_main_menu())
        return
    
    response = "üìã <b>–í—Å–µ –≤–∞—à–∏ —Å–æ–±—ã—Ç–∏—è:</b>\n\n"
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
    sorted_dates = sorted(user_schedules.keys())
    
    for date_time_str in sorted_dates:
        date_part = date_time_str.split()[0]
        time_part = date_time_str.split()[1][:5] if ' ' in date_time_str else ""
        
        date_obj = datetime.strptime(date_part, '%Y-%m-%d')
        formatted_date = date_obj.strftime('%d.%m.%Y')
        
        response += f"üìÖ <b>{formatted_date} {time_part}</b>\n"
        
        events = user_schedules[date_time_str]
        for event_id, event_data in events.items():
            text = event_data["text"][:40] + ("..." if len(event_data["text"]) > 40 else "")
            response += f"  ‚Ä¢ {text} (ID: {event_id})\n"
        
        response += "\n"
    
    await update.message.reply_html(response, reply_markup=build_main_menu())

async def start_add_event(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è."""
    await update.message.reply_text(
        "üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É —Å–æ–±—ã—Ç–∏—è:",
        reply_markup=create_date_keyboard()
    )
    return DATE

async def select_date(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –¥–∞—Ç—ã."""
    query = update.callback_query
    await query.answer()
    
    if query.data == "cancel":
        await query.edit_message_text("‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        return ConversationHandler.END
    
    elif query.data == "other_date":
        await query.edit_message_text(
            "üìÖ –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15.12.2024):"
        )
        return DATE
    
    else:
        # –í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞ –∏–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        date_str = query.data.replace("date_", "")
        context.user_data['selected_date'] = date_str
        
        date_obj = datetime.strptime(date_str, '%Y-%m-%d')
        formatted_date = date_obj.strftime('%d.%m.%Y')
        
        await query.edit_message_text(
            f"üìÖ –í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞: <b>{formatted_date}</b>\n\n"
            "‚è∞ –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:",
            parse_mode='HTML',
            reply_markup=create_time_keyboard()
        )
        return TIME

async def select_time(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏."""
    query = update.callback_query
    await query.answer()
    
    if query.data == "cancel":
        await query.edit_message_text("‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        return ConversationHandler.END
    
    elif query.data == "other_time":
        await query.edit_message_text(
            "‚è∞ –í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ß:–ú–ú (–Ω–∞–ø—Ä–∏–º–µ—Ä, 14:30):"
        )
        return TIME
    
    else:
        # –í—ã–±—Ä–∞–Ω–æ –≤—Ä–µ–º—è –∏–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        time_str = query.data.replace("time_", "")
        context.user_data['selected_time'] = time_str
        
        await query.edit_message_text(
            f"‚è∞ –í—ã–±—Ä–∞–Ω–æ –≤—Ä–µ–º—è: <b>{time_str}</b>\n\n"
            "üìù –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:",
            parse_mode='HTML'
        )
        return TEXT

async def input_date(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –¥–∞—Ç—ã –≤—Ä—É—á–Ω—É—é."""
    try:
        date_str = update.message.text.strip()
        # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç—ã
        for fmt in ('%d.%m.%Y', '%d.%m.%y', '%d-%m-%Y', '%d/%m/%Y'):
            try:
                date_obj = datetime.strptime(date_str, fmt)
                context.user_data['selected_date'] = date_obj.strftime('%Y-%m-%d')
                
                await update.message.reply_text(
                    f"üìÖ –í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞: <b>{date_obj.strftime('%d.%m.%Y')}</b>\n\n"
                    "‚è∞ –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:",
                    parse_mode='HTML',
                    reply_markup=create_time_keyboard()
                )
                return TIME
            except ValueError:
                continue
        
        raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã")
        
    except ValueError:
        await update.message.reply_text(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì:"
        )
        return DATE

async def input_time(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –≤—Ä–µ–º–µ–Ω–∏ –≤—Ä—É—á–Ω—É—é."""
    try:
        time_str = update.message.text.strip()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏
        datetime.strptime(time_str, '%H:%M')
        context.user_data['selected_time'] = time_str
        
        await update.message.reply_text(
            f"‚è∞ –í—ã–±—Ä–∞–Ω–æ –≤—Ä–µ–º—è: <b>{time_str}</b>\n\n"
            "üìù –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:",
            parse_mode='HTML'
        )
        return TEXT
        
    except ValueError:
        await update.message.reply_text(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ß:–ú–ú:"
        )
        return TIME

async def input_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –æ–ø–∏—Å–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è."""
    event_text = update.message.text.strip()
    
    if not event_text:
        await update.message.reply_text("‚ùå –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:")
        return TEXT
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
    selected_date = context.user_data.get('selected_date')
    selected_time = context.user_data.get('selected_time')
    
    if not selected_date or not selected_time:
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        return ConversationHandler.END
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é –¥–∞—Ç—É-–≤—Ä–µ–º—è
    date_time_str = f"{selected_date} {selected_time}"
    
    try:
        event_datetime = datetime.strptime(date_time_str, "%Y-%m-%d %H:%M")
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        user_id = update.effective_user.id
        new_id = schedule_manager.add_schedule(user_id, date_time_str, event_text)
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
        reminder_time = event_datetime - REMINDER_TIME_DELTA
        context.job_queue.run_once(
            send_reminder, 
            when=reminder_time, 
            chat_id=user_id, 
            user_id=user_id, 
            event_text=event_text, 
            reminder_time=selected_time
        )
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        date_obj = datetime.strptime(selected_date, '%Y-%m-%d')
        formatted_date = date_obj.strftime('%d.%m.%Y')
        
        await update.message.reply_html(
            f"‚úÖ <b>–°–æ–±—ã—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!</b>\n\n"
            f"üìÖ –î–∞—Ç–∞: {formatted_date}\n"
            f"‚è∞ –í—Ä–µ–º—è: {selected_time}\n"
            f"üìù –û–ø–∏—Å–∞–Ω–∏–µ: {event_text}\n"
            f"üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 30 –º–∏–Ω—É—Ç –¥–æ —Å–æ–±—ã—Ç–∏—è",
            reply_markup=build_main_menu()
        )
        
    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è: {str(e)}")
    
    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    context.user_data.clear()
    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é."""
    await update.message.reply_text(
        "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.",
        reply_markup=build_main_menu()
    )
    context.user_data.clear()
    return ConversationHandler.END

async def show_calendar(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å —Å–æ–±—ã—Ç–∏—è–º–∏."""
    user_id = update.effective_user.id
    user_schedules = schedule_manager.schedules.get(str(user_id), {})
    
    if not user_schedules:
        await update.message.reply_html(
            "üóìÔ∏è <b>–í–∞—à –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø—É—Å—Ç</b>\n\n"
            "–î–æ–±–∞–≤—å—Ç–µ —Å–æ–±—ã—Ç–∏—è, —á—Ç–æ–±—ã –æ–Ω–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –∑–¥–µ—Å—å.",
            reply_markup=build_main_menu()
        )
        return
    
    today = datetime.now()
    response = "üóìÔ∏è <b>–í–∞—à –∫–∞–ª–µ–Ω–¥–∞—Ä—å:</b>\n\n"
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ –¥–∞—Ç–∞–º
    events_by_date = {}
    for datetime_str, events in user_schedules.items():
        date_part = datetime_str.split()[0]
        if date_part not in events_by_date:
            events_by_date[date_part] = []
        
        time_part = datetime_str.split()[1][:5] if ' ' in datetime_str else ""
        for event_id, event_data in events_by_date[date_part].items():
            events_by_date[date_part].append({
                'time': time_part,
                'text': event_data["text"],
                'id': event_id
            })
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
    sorted_dates = sorted(events_by_date.keys())
    
    for date_str in sorted_dates[:10]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ 10 –±–ª–∏–∂–∞–π—à–∏—Ö –¥–∞—Ç
        date_obj = datetime.strptime(date_str, '%Y-%m-%d')
        formatted_date = date_obj.strftime('%d.%m.%Y')
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–µ–≥–æ–¥–Ω—è –ª–∏ —ç—Ç–æ
        if date_obj.date() == today.date():
            date_label = f"üìå –°–µ–≥–æ–¥–Ω—è ({formatted_date})"
        elif date_obj.date() == (today + timedelta(days=1)).date():
            date_label = f"üìå –ó–∞–≤—Ç—Ä–∞ ({formatted_date})"
        else:
            date_label = f"üìÖ {formatted_date}"
        
        response += f"{date_label}\n"
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        events = sorted(events_by_date[date_str], key=lambda x: x['time'])
        for event in events[:3]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ 3 —Å–æ–±—ã—Ç–∏—è –Ω–∞ –¥–∞—Ç—É
            text = event['text'][:30] + ("..." if len(event['text']) > 30 else "")
            response += f"  ‚Ä¢ {event['time']} - {text}\n"
        
        if len(events) > 3:
            response += f"  ... –∏ –µ—â–µ {len(events) - 3} —Å–æ–±—ã—Ç–∏–π\n"
        
        response += "\n"
    
    if len(sorted_dates) > 10:
        response += f"\n... –∏ –µ—â–µ {len(sorted_dates) - 10} –¥–Ω–µ–π"
    
    await update.message.reply_html(response, reply_markup=build_main_menu())

async def start_delete_event(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è."""
    user_id = update.effective_user.id
    user_schedules = schedule_manager.schedules.get(str(user_id), {})
    
    if not user_schedules:
        await update.message.reply_html(
            "üóëÔ∏è –£ –≤–∞—Å –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.",
            reply_markup=build_main_menu()
        )
        return
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å —Å–æ–±—ã—Ç–∏—è–º–∏
    buttons = []
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ –¥–∞—Ç–µ
    sorted_dates = sorted(user_schedules.keys())
    
    for datetime_str in sorted_dates[:15]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ 15 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–±—ã—Ç–∏–π
        date_part = datetime_str.split()[0]
        time_part = datetime_str.split()[1][:5] if ' ' in datetime_str else ""
        
        date_obj = datetime.strptime(date_part, '%Y-%m-%d')
        formatted_date = date_obj.strftime('%d.%m')
        
        events = user_schedules[datetime_str]
        for event_id, event_data in events.items():
            text = event_data["text"][:20] + ("..." if len(event_data["text"]) > 20 else "")
            label = f"{formatted_date} {time_part}: {text}"
            callback_data = f"delete_{datetime_str}_{event_id}"
            buttons.append([InlineKeyboardButton(label, callback_data=callback_data)])
    
    buttons.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_delete")])
    
    await update.message.reply_text(
        "üóëÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:",
        reply_markup=InlineKeyboardMarkup(buttons)
    )

async def delete_event_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è."""
    query = update.callback_query
    await query.answer()
    
    if query.data == "cancel_delete":
        await query.edit_message_text("‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        return
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
    _, datetime_str, event_id = query.data.split('_', 2)
    
    user_id = update.effective_user.id
    success = schedule_manager.remove_schedule(user_id, datetime_str, event_id)
    
    if success:
        await query.edit_message_text("‚úÖ –°–æ–±—ã—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!")
    else:
        await query.edit_message_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ.")

async def show_help(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É."""
    help_text = (
        "‚ùì <b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º:</b>\n\n"
        
        "üìÖ <b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
        "‚Ä¢ <b>üìÖ –°–µ–≥–æ–¥–Ω—è</b> - –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n"
        "‚Ä¢ <b>üìÖ –ó–∞–≤—Ç—Ä–∞</b> - –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞\n"
        "‚Ä¢ <b>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</b> - –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ\n"
        "‚Ä¢ <b>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</b> - —É–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–±—ã—Ç–∏–µ\n"
        "‚Ä¢ <b>üìã –í—Å–µ —Å–æ–±—ã—Ç–∏—è</b> - –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è\n"
        "‚Ä¢ <b>üóìÔ∏è –ö–∞–ª–µ–Ω–¥–∞—Ä—å</b> - –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å —Å–æ–±—ã—Ç–∏—è–º–∏\n\n"
        
        "üìù <b>–§–æ—Ä–º–∞—Ç—ã –≤–≤–æ–¥–∞:</b>\n"
        "‚Ä¢ –î–∞—Ç–∞: –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15.12.2024)\n"
        "‚Ä¢ –í—Ä–µ–º—è: –ß–ß:–ú–ú (–Ω–∞–ø—Ä–∏–º–µ—Ä, 14:30)\n\n"
        
        "üîî <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:</b>\n"
        "–Ø –±—É–¥—É –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –≤–∞–º –æ —Å–æ–±—ã—Ç–∏—è—Ö –∑–∞ 30 –º–∏–Ω—É—Ç –¥–æ –∏—Ö –Ω–∞—á–∞–ª–∞."
    )
    
    await update.message.reply_html(help_text, reply_markup=build_main_menu())

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é."""
    text = update.message.text
    
    if text == "üìÖ –°–µ–≥–æ–¥–Ω—è":
        await show_today(update, context)
    elif text == "üìÖ –ó–∞–≤—Ç—Ä–∞":
        await show_tomorrow(update, context)
    elif text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ":
        await start_add_event(update, context)
    elif text == "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ":
        await start_delete_event(update, context)
    elif text == "üìã –í—Å–µ —Å–æ–±—ã—Ç–∏—è":
        await show_all_events(update, context)
    elif text == "üóìÔ∏è –ö–∞–ª–µ–Ω–¥–∞—Ä—å":
        await show_calendar(update, context)
    elif text == "‚ùì –ü–æ–º–æ—â—å":
        await show_help(update, context)
    else:
        await update.message.reply_text(
            "–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é —ç—Ç—É –∫–æ–º–∞–Ω–¥—É. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏–ª–∏ /help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏.",
            reply_markup=build_main_menu()
        )

async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∑–∞–ø—Ä–æ—Å–æ–≤."""
    query = update.callback_query
    await query.answer()
    
    if query.data.startswith('delete_'):
        await delete_event_callback(update, context)
    else:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö callback-–∑–∞–ø—Ä–æ—Å–æ–≤
        pass

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    app = Application.builder().token(TOKEN).build()
    
    # –°–æ–∑–¥–∞–µ–º ConversationHandler –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
    conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex('^‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ$'), start_add_event)],
        states={
            DATE: [
                CallbackQueryHandler(select_date, pattern='^(date_|other_date|cancel)$'),
                MessageHandler(filters.TEXT & ~filters.COMMAND, input_date)
            ],
            TIME: [
                CallbackQueryHandler(select_time, pattern='^(time_|other_time|cancel)$'),
                MessageHandler(filters.TEXT & ~filters.COMMAND, input_time)
            ],
            TEXT: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, input_text)
            ]
        },
        fallbacks=[CommandHandler("cancel", cancel)]
    )
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", show_help))
    app.add_handler(CommandHandler("today", show_today))
    app.add_handler(CommandHandler("tomorrow", show_tomorrow))
    app.add_handler(CommandHandler("calendar", show_calendar))
    app.add_handler(CommandHandler("all", show_all_events))
    app.add_handler(CommandHandler("delete", start_delete_event))
    
    # –î–æ–±–∞–≤–ª—è–µ–º ConversationHandler
    app.add_handler(conv_handler)
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é)
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), handle_text))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ inline-–∫–Ω–æ–ø–æ–∫
    app.add_handler(CallbackQueryHandler(button_callback))
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    app.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()
